<!DOCTYPE html>
<html>
<head>
    <title>Safe Code Executor</title>
    <style>
        body { font-family: Arial; margin: 20px; display: flex; gap: 20px; }
        #editorContainer { width: 70%; }
        #historyPanel { width: 25%; padding: 10px; border: 1px solid #ccc; height: 600px; overflow-y: auto; }
        #output { white-space: pre-wrap; border: 1px solid #aaa; padding: 10px; height: 150px; overflow-y: auto; }
        #zipForm { margin-top: 20px; }
    </style>

    <!-- CodeMirror CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/lib/codemirror.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/theme/material.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/mode/python/python.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.13/mode/javascript/javascript.js"></script>

</head>

<body>

    <div id="editorContainer">
        <h2>Safe Code Executor</h2>

        Language:
        <select id="language">
            <option value="python">Python</option>
            <option value="javascript">JavaScript</option>
        </select>

        <textarea id="code" style="display:none;">print("Hello")</textarea>
        <div id="editor" style="height:300px;border:1px solid #ccc;"></div>

        <button id="runBtn">Run</button>
        <button id="clearBtn">Clear</button>

        <h3>Output:</h3>
        <div id="output"></div>

        <hr>

        <h3>Run ZIP Project</h3>
        <form id="zipForm">
            <input type="file" id="zipFile" accept=".zip">
            <button type="button" id="uploadZipBtn">Run ZIP</button>
        </form>
    </div>

    <div id="historyPanel">
        <h3>History</h3>
        <div id="historyList"></div>
    </div>

<script>
    // Initialize CodeMirror
    var textarea = document.getElementById("code");
    var editor = CodeMirror(document.getElementById("editor"), {
        value: textarea.value,
        mode: "python",
        theme: "material",
        lineNumbers: true
    });

    // Switch syntax mode
    document.getElementById("language").onchange = function(){
        editor.setOption("mode", this.value === "javascript" ? "javascript" : "python");
    };

    // Run code
    document.getElementById("runBtn").onclick = async () => {
        const code = editor.getValue();
        const language = document.getElementById("language").value;

        const response = await fetch("/run", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({language, code})
        });

        const result = await response.json();

        // Correct output handling
        document.getElementById("output").innerText =
            result.stdout ? result.stdout :
            result.stderr ? ("Error:\n" + result.stderr) :
            "Unknown error";

        loadHistory();
    };

    // Clear editor
    document.getElementById("clearBtn").onclick = () => {
        editor.setValue("");
        document.getElementById("output").innerText = "";
    };

    // ZIP upload
    document.getElementById("uploadZipBtn").onclick = async () => {
        const file = document.getElementById("zipFile").files[0];
        if (!file) return alert("Choose a ZIP file!");

        const fd = new FormData();
        fd.append("file", file);

        const res = await fetch("/run-zip", { method: "POST", body: fd });
        const out = await res.json();

        document.getElementById("output").innerText =
            out.stdout ? out.stdout :
            out.stderr ? ("Error:\n" + out.stderr) :
            "Unknown error";

        loadHistory();
    };

    // Load history
    async function loadHistory(){
        const res = await fetch("/history");
        const list = await res.json();
        const div = document.getElementById("historyList");

        div.innerHTML = "";
        list.forEach(h => {
            div.innerHTML += `<div style="margin-bottom:10px;">
                 <b>${h.language}</b><br>${h.code}
            </div>`;
        });
    }

    loadHistory();
</script>

</body>
</html>
